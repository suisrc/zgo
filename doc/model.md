# 数据库

```sql
PRIMARY KEY (`id`)
FOREIGN KEY fk_key(`xxx_id`)
REFERENCES xxx(`id`)
INDEX index_name (title(length))
UNIQUE index_name (title(length))
```
primary: 主键  

udx_xxx: 唯一索引  
idx_xxx: 索引  

fk_xxxx: 外键  
fk_account_user->user.id  

```sql model
ARG tbl=zgo_

includes=
excludes=
```
"| -" 标识注释,该行的内容会被忽略
## 账户实体(`account`)

管理用户登陆控制,oauth2_token令牌为用户令牌, 与服务器令牌需要区别
同一个用户可以具有多个账户实体,每一种账户实体代表用户的一种登陆方式
用户每次绑定一个第三方账户,在实体中就会增加一条该用户的账户
当前用户如果绑定用户名,邮箱,手机登陆,意味着该用户具有3个本地实体
密码加密方式, password_type -> MD5和SHA1是一种依赖MD5和SHA1的自定义变种加密方式, BCR是标准的bcrypt加密,BCR2和BCR3是对盐值进行了加密
BCR2 -> 对salt进行了简单的倒序处理, BCR3 -> 对salt进行了以hashpassword为基础的位运算加密,不会影响其执行速度, 注意,其可以基于本身进行解密处理
经过测试, MD5和SHA1 -> 0.170s/万次, BCR -> 667s/万次, MD5和SHA1的执行效率大约是BCR的4000~5000倍, 在非必要请求下,请使用MD5或者SHA1

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | --------------------------------------------------- | ---------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| pid           | 上级账户       | 字符串   | 当前账户验证密码的方式为PID时候,使用上级账户验证    | int(11)                                              |
| account       | 账户           | 字符串   | 账户和账户类型和账户归属平台构成唯一标识            | varchar(255) NOT NULL, udx_account                   |
| account_typ   | 账户类型       | 字符串   | 1:name 2:mobile 3:email 4:openid 5:unionid 6:token  | tinyint(4) DEFAULT '1', udx_account                  |
| account_kid   | 账户归属平台   | 字符串   | 被授权平台, NULL标识不归属任何平台                  | varchar(64), udx_account,fk_account_kid->oauth2_platform.kid |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| password      | 登录密码       | 字符串   | 1.密码, 2:签名密钥 3:密钥 4:密钥                    | varchar(255)                                         |
| password_salt | 密码盐值       | 字符串   | 加密规则加固, 防止暴力破解                          | varchar(255)                                         |
| password_type | 密码方式       | 字符串   | 1:(明文) 2:MD5 3:SHA1 4: BCR 5: BCR2 6: BCR3        | varchar(16)                                          |
| verify_secret | 校验密钥       | 字符串   | SMS 和 OAUTH2 验证时候,对状态进行签名               | varchar(255)                                         |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| user_id       | 用户标识       | 数值     |                                                     | int(11) NOT NULL, fk_account_user->user.id           |
| role_id       | 角色标识       | 数值     | 如果不为空,表示账户和角色已绑定                     | int(11), fk_account_role->role.id                    |
| status        | 状态           | 数值     | 1:启用 0:禁用                                       | tinyint(4) DEFAULT 1                                 |
| description   | 账户描述       | 字符串   |                                                     | varchar(255)                                         |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| oa2_token     | oauth2令牌     | 字符串   | 服务器间通信令牌有二种, 用户(用户) VS 服务器        | varchar(1024)                                        |
| oa2_expired   | oauth2过期时间 | 时间格式 | 令牌过期时间, expired                               | int(11)                                              |
| oa2_refresh   | 刷新令牌       | 字符串   |                                                     | varchar(2048)                                        |
| oa2_fake      | 伪造令牌       | 字符串   | 特殊永生令牌, 备用                                  | varchar(1024)                                        |
| oa2_client    | 客户端上次     | 数值     | oauth2_account                                      | int(11), idx_account_client                          |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| string_2      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| string_3      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |
| number_2      | 备用字段       | 数值     |                                                     | int(11)                                              |
| number_3      | 备用字段       | 数值     |                                                     | int(11)                                              |

---
## 第三方登陆实体(`oauth2_platform`)

用于第三方授权登陆我们的系统

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| kid           | 三方标识       | 字符串   |                                                     | varchar(64)  NOT NULL, udx_oauth2_platform_kid       |
| platform      | 平台标识       | 字符串   | 1:WX 2:TB 3:JD 4:GITEA 5: WXQ 6...                  | varchar(32) NOT NULL                                 |
| app_id        | 应用标识       | 字符串   |                                                     | varchar(255)                                         |
| app_secret    | 应用密钥       | 字符串   |                                                     | varchar(1024)                                        |
| avatar        | 平台头像       | 字符串   |                                                     | varchar(255)                                         |
| description   | 平台描述       | 字符串   |                                                     | varchar(255)                                         |
| status        | 状态           | 数值     | 1:启用 0:禁用                                       | tinyint(4) DEFAULT 1                                 |
| signin        | 可登陆         | 数值     | 1:启用 0:禁用                                       | tinyint(4) DEFAULT 0                                 |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| agent_id      | 代理商标识     | 字符串   |                                                     | varchar(255)                                         |
| agent_secret  | 代理商密钥     | 字符串   |                                                     | varchar(1024)                                        |
| suite_id      | 套件标识       | 字符串   |                                                     | varchar(255)                                         |
| suite_secret  | 套件密钥       | 字符串   |                                                     | varchar(1024)                                        |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| authorize_url | 认证地址       | 字符串   |                                                     | varchar(1024)                                        |
| token_url     | 令牌地址       | 字符串   |                                                     | varchar(1024)                                        |
| profile_url   | 个人资料地址   | 字符串   |                                                     | varchar(1024)                                        |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| js_secret     | javascript密钥 | 字符串   | 需要js签名认证时候,进行认证的key                    | varchar(255)                                         |
| state_secret  | 回调state密钥  | 字符串   | 缓存处理state,用密钥计算state具有更好的分布式       | varchar(255)                                         |
| callback      | 是否支持回调   | 数值     |                                                     | tinyint(4) DEFAULT 0                                 |
| cb_domain     | 默认域名       | 字符串   |                                                     | varchar(128)                                         |
| cb_scheme     | 默认协议       | 字符串   |                                                     | varchar(16) DEFAULT 'https'                          |
| cb_encrypt    | 回调是否加密   | 数值     |                                                     | tinyint(4) DEFAULT 0                                 |
| cb_token      | 加密令牌       | 字符串   |                                                     | varchar(255)                                         |
| cb_encoding   | 加密编码       | 字符串   |                                                     | varchar(255)                                         |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |

---
## 第三方通信实体(`oauth2_token`)

与第三方系统通信时候,使用的令牌,为我服务器使用令牌与其他服务器通信的记录,也可用于集群中应用对第三方服务器访问的信息共享

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| oauth2_id     | 平台           | 字符串   |                                                     | int(11), fk_oa2_token_id->oauth2_platform.id         |
| access_token  | 代理商标识     | 字符串   |                                                     | varchar(1024)                                        |
| expires_in    | 有限期间隔     | 字符串   |                                                     | int(11) DEFAULT 7200                                 |
| expires_time  | 凭据过期时间   | 字符串   |                                                     | int(11), idx_oa2_exp_time                            |
| sync_lock     | 同步锁         | 数值     | 同步锁,表示有人在更新令牌                           | tinyint(4) DEFAULT 0                                 |
| sync_time     | 同步锁时间     | 数值     | 用于同步操作时候,其他应用的刷新间隔, 单位秒, 1~127  | tinyint(4) DEFAULT 1                                 |
| call_count    | 调用次数       | 数值     | 令牌被使用的次数, 注意开发时需要降低更新频次        | int(11) DEFAULT 0                                    |
| token_type    | 令牌类型       | 字符串   | 标记令牌的类型, 备用字段                            | varchar(32)                                          |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |

---
## 第三方授权实体(`oauth2_client`)

我们的系统提供第三方登陆, 系统中不涉及第三方签发的令牌, 用户可以直接通过jwt访问我们系统
注意:如果用户签发的令牌具有audience权限,需要限定其使用, 可以在网关配置中增加jwt验证权限,拒绝该请求
如果audience为空,标识全平台通用,注意,对于多系统来说,不要使用签发后的内容为hostname, issuer如果为空,签发后为hostname

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| kid           | 客户端标识     | 字符串   | jwt的header[kid], 请求未指定看audience              | varchar(64)  NOT NULL, udx_oauth2_client_kid         |
| audience      | 令牌接受平台   | 字符串   |                                                     | varchar(255)                                         |
| issuer        | 令牌签发平台   | 字符串   |                                                     | varchar(255)                                         |
| expired       | 令牌有效期     | 数值     | 7200                                                | int(11) DEFAULT 7200                                 |
| token_type    | 令牌类型       | 数值     | JWT 不可修改                                        | varchar(32) DEFAULT 'JWT'                            |
| token_method  | 令牌方法       | 字符串   | HS512 不可修改                                      | varchar(32) DEFAULT 'HS512'                          |
| token_secret  | 令牌密钥       | 字符串   | signing secret                                      | varchar(255) NOT NULL                                |
| token_getter  | 令牌获取方法   | 字符串   | 1.header(Authorization) 2.query(token)              | varchar(32)                                          |
| -             |                |          | 3.cookie(authorization) (备用字段)                  |                                                      |
| signin_url    | 登陆地址       | 字符串   | 未指定redirect时候,默认的跳转地址                   | varchar(2048)                                        |
| signin_force  | 强制跳转登陆   | 数值     | false                                               | tinyint(4) DEFAULT 0                                 |
| signin_check  | 登陆确认       | 数值     | false, 登陆是否需要确认                             | tinyint(4) DEFAULT 0                                 |
| status        | 状态           | 数值     | 1:启用 0:禁用                                       | tinyint(4) DEFAULT 1                                 |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |

---
## 第三方授权实体(`oauth2_account`)

第三方授权实体, 用户完成授权后,需要处理令牌,选择授权系统
已知: 
A用户:  [host]          请求域
        [client]            应用ID
B角色:  [Role.domain]       角色域
C应用:  [Client.kid]        应用ID
        [Client.audience]   接受域
约束:
0.[Client]为空, 通过[host]确认[Client], 如果存在多个,随机选择
1.[Client]为空, [Role.domain]必须为空或者等于[host]
2.[Client.audience]不为空, 必须等于[host]
3.[Role.domain]为空, 直接返回true, 该角色为全平台角色 
4.[Client.audience]不为空, 必须等于[Role.domain]需要匹配
5.验证[Role.domain]和[host]

角色约束:
1.如果当前账户的角色可以授权,直接授权
2.如果该用户具有单角色,登陆的子系统没有角色,则放弃授权
3.如果具有多角色,优先使用上次登陆的角色登陆系统, 如果上次的角色被剥夺或者第一次登陆的情况使用第四条规则
4.选择第一角色直接授权,并提供角色选择接口

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| account_id    | 账户标识       | 数值     |                                                     | int(11) NOT NULL, idx_oauth2_account_aid             |
| client_id     | 客户端标识     | 数值     |                                                     | int(11), idx_oauth2_account_cid                      |
| client_kid    | 客户端标识     | 数值     |                                                     | varchar(64), idx_oauth2_account_ckid                 |
| user_kid      | 用户标识       | 数值     |                                                     | varchar(64), idx_oauth2_account_ukid                 |
| role_kid      | 角色标识       | 数值     |                                                     | varchar(64), idx_oauth2_account_rkid                 |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| last_ip       | 上次登陆IP     | 字符串   |                                                     | varchar(64)                                          |
| last_at       | 上次登陆时间   | 时间格式 |                                                     | timestamp                                            |
| limit_exp     | 限制登陆       | 时间格式 | 限制登陆的接受时间(限定单位秒)                      | timestamp                                            |
| limit_key     | 限制登陆       | 字符串   | 解除限制登陆的方式,null表述限制无法解除             | varchar(255)                                         |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| mode          | 方式           | 字符串   | 1:signin 2:refresh 3:oauth2                         | varchar(16) DEFAULT 'signin'                         |
| expires_at    | 授权有效期     | 数值     |                                                     | int(11), idx_oauth2_account_expires                  |
| access_token  | 访问令牌       | 字符串   | 最后一次密钥(二次密钥小于300秒, 直接返回)           | varchar(2048)                                        |
| refresh_token | 刷新令牌       | 字符串   |                                                     | varchar(128), idx_oauth2_account_rtid                |
| refresh_count | 刷新次数       | 数值     |                                                     | int(11) DEFAULT 0                                    |
| status        | 状态           | 数值     | 1:启用 0:禁用 (备用)                                | tinyint(4) DEFAULT 1                                 |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |

---
## 用户实体(`user`)

用户实体操作非常频繁,所以,其中的内容应该尽可能保存的少,更多详细信息可以通过detail进行保存
我们可以看到该实体没有共同字段,理由是共同字段可以通过detail得到,所以对于user实体无需共同字段
该内容未完,可进行扩展处理

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| kid           | 唯一标识       | 字符串   | 主要注意屏蔽系统中的id                              | varchar(64), udx_user_kid                            |
| name          | 用户名         | 字符串   |                                                     | varchar(64), idx_user_name                           |
| status        | 状态           | 数值     | 1:启用 0:禁用                                       | tinyint(4) DEFAULT 1                                 |
| delete        | 删除标识       | 数值     | 1:删除 0:正常  (用户是否被销户)                     | tinyint(4) DEFAULT 0                                 |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |

---
## 角色实体(`role`)

一个用户登陆系统后,只能有一个角色存在,如果有多角色的情况,需要进行选择
本质上角色是没有域的概念的,但是为了方便管理,所以证件域的选项

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| kid           | 唯一标识       | 字符串   | 主要注意屏蔽系统中的id                              | varchar(64), udx_role_kid                            |
| name          | 角色名         | 字符串   |                                                     | varchar(64), udx_role_name                           |
| description   | 角色描述       | 字符串   |                                                     | varchar(128)                                         |
| status        | 状态           | 数值     | 1:启用 0:禁用                                       | tinyint(4) DEFAULT 1                                 |
| domain        | 域             | 字符串   | 角色域, 多系统账户来说,角色应该是跨域的             | varchar(255)                                         |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |

---
## 角色角色实体(`role_role`)

角色赋值时候,可能出现环,所以在保存角色时候,需要对角色进行校验,防止环形角色情况发生
角色中,会出现递归授权的问题,如何做到角色快速可达,是一个问题, 不过我们可以通过[Enforcer.GetImplicitRolesForUser]快速获取用户的角色列表

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| owner_id      | 父节点标识     | 数值     |                                                     | int(11), fk_role_owner_id->role.id                   |
| child_id      | 子节点标识     | 数值     |                                                     | int(11), fk_role_child_id->role.id                   |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |

---
## 用户角色实体(`user_role`)

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| user_id       | 账户标识       | 数值     |                                                     | int(11), fk_role_user_id->user.id                    |
| role_id       | 客户端标识     | 数值     |                                                     | int(11), fk_role_role_id->role.id                    |
| expired       | 授权有效期     | 时间格式 |                                                     | int(11)                                              |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |

---
## 资源实体(`resource`)

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| resource      | 资源名         | 字符串   | 资源名可以重复, 即该资源标识一类资源而不是单独      | varchar(64), idx_resource_name                       |
| domain        | 域名           | 字符串   | api.io                                              | varchar(255)                                         |
| methods       | 方法           | 字符串   | (GET)(POST)(PUT)(DELETE)                            | varchar(64)                                          |
| path          | 路径           | 字符串   | /api/*                                              | varchar(255)                                         |
| netmask       | 网络掩码       | 字符串   | 0.0.0.0/0                                           | varchar(64)                                          |
| allow         | 允许vs拒绝     | 数值     | 1: allow 0:deny                                     | tinyint(4)                                           |
| description   | 描述           | 字符串   |                                                     | varchar(128)                                         |
| status        | 状态           | 数值     | 1:启用 0:禁用                                       | tinyint(4) DEFAULT 1                                 |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |

---
## 资源角色实体(`resource_role`)

这里使用资源角色而非角色资源,是为了兼容casbin方式,我们对资源如下定义:
资源是一类请求资源的合集,而非一个.请求资源有唯一标识,但是资源没有,角色和资源绑定.

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| role_id       | 角色           | 数值     |                                                     | int(11), fk_resource_role_id->role.id                |
| resource      | 资源名         | 字符串   |                                                     | varchar(64), fk_resource_role_res->resource.resource |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |

---
## 资源角色实体(`resource_user`)

用于对某一个用户进行单独屏蔽操作, 非特殊情况下不推荐使用

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| user_id       | 用户           | 数值     |                                                     | int(11), fk_resource_user_id->user.id                |
| resource      | 资源名         | 字符串   |                                                     | varchar(64), fk_resource_user_res->resource.resource |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |

---
## 菜单实体(`menu`)

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| kid           | 唯一标识       | 字符串   |                                                     | varchar(32), udx_menu_kid                            |
| name          | 菜单名称       | 字符串   |                                                     | varchar(64)                                          |
| local         | 菜单名称       | 字符串   | 可以直接抽取前端i18n对应的内容                      | varchar(128)                                         |
| sequence      | 排序值         | 数值     |                                                     | tinyint(4) DEFAULT 64                                |
| group         | 菜单分组       | 字符串   |                                                     | varchar(64)                                          |
| group_local   | 菜单分组       | 字符串   |                                                     | varchar(64)                                          |
| icon          | 图标           | 字符串   |                                                     | varchar(255)                                         |
| router        | 访问路由       | 字符串   |                                                     | varchar(255)                                         |
| memo          | 备注           | 字符串   |                                                     | varchar(255)                                         |
| domain        | 域名           | 字符串   |                                                     | varchar(255)                                         |
| status        | 状态           | 数值     | 1:启用 0:禁用                                       | tinyint(4) DEFAULT 1                                 |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |

---
## 角色自定义菜单实体(`menu_role`)

角色具有包含角色的性质,所有在处理角色上,需要遍历角色,规则如下:  
1.使用角色获取菜单, 如果非空,直接结束,由于角色递归, 需要进行递归遍历  
2.如果都没有的情况下,使用role_id=nil获取菜单,不进行递归,该菜单列表认为是所有人可见的默认菜单  
这里会出现一个状况,一个角色继承了二个以上的角色,这时候,同一个菜单会被展示多次,暂时并未想好合适的解决方式

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| pid           | 父节点         | 数值     |                                                     | int(11), idx_parent_id                               |
| kid           | 唯一标识       | 字符串   |                                                     | varchar(32), udx_menu_role_kid                       |
| name          | 菜单名称       | 字符串   | 父节点不能为空,子节点为空,使用menu_id替换           | varchar(64)                                          |
| local         | 菜单名称       | 字符串   |                                                     | varchar(128)                                         |
| sequence      | 排序值         | 数值     |                                                     | tinyint(4) DEFAULT 64                                |
| role_id       | 角色 ID        | 数值     |                                                     | int(11), fk_menu_role_role_id->role.id               |
| role_kid      | 角色 UID       | 字符串   | 与role_id效果相同                                   | varchar(64), idx_role_kid                            |
| menu_id       | 菜单 ID        | 数值     |                                                     | int(11), fk_menu_role_menu_id->menu.id               |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |

---
## 角色自定义菜单实体(`menu_user`)

用户自定义菜单, 用户可以在自己可以查看的菜单中选择常用的菜单,进行展示,
展示的内容

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| role_id       | 角色 ID        | 数值     |                                                     | int(11), fk_menu_user_role_id->role.id               |
| role_kid      | 角色 UID       | 字符串   |                                                     | varchar(64), idx_role_kid                            |
| user_id       | 用户 ID        | 数值     |                                                     | int(11), fk_menu_user_user_id->user.id               |
| user_kid      | 用户 UID       | 字符串   |                                                     | varchar(64), idx_user_kid                            |
| menu_ids      | 菜单 ID        | 字符串   | menu kid list                                       | varchar(4096)                                        |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |

---
## 菜单事件实体(`menu_action`)

主要用户系统中对操作的隐藏,如果需要禁用,需要配合resource使用,默认权限为启用
该内容一般用户初始化前端页面,用于对低权限的人屏蔽修改操作
由于casbin在系统中是由否定优先规则,即当系统中角色具有一票否决,通过role的向下遍历,确定角色上是否有操作的否决即可

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| menu_id       | 菜单 ID        | 数值     |                                                     | int(11), fk_menu_action_menu_id->menu.id             |
| role_id       | 角色 ID        | 数值     |                                                     | int(11), fk_menu_action_role_id->role.id             |
| role_kid      | 角色 UID       | 字符串   |                                                     | varchar(64), idx_role_kid                            |
| code          | 动作编号       | 字符串   |                                                     | varchar(64), idx_menu_action_code                    |
| name          | 动作名称       | 字符串   |                                                     | varchar(64), idx_menu_action_name                    |
| disable       | 状态           | 数值     | 0:启用 1:禁用                                       | tinyint(4) DEFAULT 0                                 |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |

---
## 系统标签实体(`tag_system`)

系统标签属于一种共享标签, 属于协助系统运行,标签只有管理员定义

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| name          | 标签           | 字符串   |                                                     | varchar(64), idx_tag_system_name                     | 
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |

---
## 系统标签实体(`tag_system_owner`)

系统标签可直接被删除

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| type          | 标签类型       | 数值     | 1:用户 2:角色 3:资源 4:平台 5:客户端                | tinyint(4)                                           |
| owner_id      | 归属id         | 数值     |                                                     | int(11), idx_tag_system_owner_id                     |
| tag_id        | 标签           | 字符串   |                                                     | int(11), fk_tag_system_owner_id->tag_system.id       | 
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |

---
## 通用标签实体(`tag_custom`)

自定义标签属于一种共享标签

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| type          | 标签类型       | 字符串   | 0: 系统 1:用户 2:角色 3:资源 4:平台 5:客户端        | tinyint(4) DEFAULT 0                                 |
| name          | 标签           | 字符串   |                                                     | varchar(64), idx_tag_custom_name                     | 
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |

---
## 通用标签实体(`tag_custom_owner`)

不可直接删除,但是可以通过逻辑删除标识删除,自定义标签为一种随意标签,本身不会影响系统运行,但是可以提供筛选条件,用于分析用户等行为

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| type          | 标签类型       | 数值     | 1:用户 2:角色 3:资源 4:平台 5:客户端                | tinyint(4)                                           |
| owner_id      | 归属id         | 数值     |                                                     | int(11), idx_tag_custom_owner_id                     |
| tag_id        | 标签           | 字符串   |                                                     | int(11), fk_tag_custom_owner_id->tag_custom.id       | 
| deleted       | 删除标识       | 字符串   | false                                               | tinyint(4) DEFAULT 0                                 |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |

---
## 国际化实体(`i18n_language`)

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| mid           | message id     | 字符串   |                                                     | varchar(255), udx_i18n_message_id                    |
| lang          | 语言           | 字符串   | zh-CN, en-US                                        | varchar(16), udx_i18n_message_id                     |
| description   | 描述           | 字符串   |                                                     | varchar(64)                                          |
| left_delim    | 定界符         | 字符串   | 左边模板定界符                                      | varchar(16)                                          |
| right_delim   | 定界符         | 字符串   | 右边模板定界符                                      | varchar(16)                                          |
| zero          | zero           | 字符串   |                                                     | varchar(255)                                         |
| one           | one            | 字符串   |                                                     | varchar(255)                                         |
| two           | two            | 字符串   |                                                     | varchar(255)                                         |
| few           | few            | 字符串   |                                                     | varchar(255)                                         |
| many          | many           | 字符串   |                                                     | varchar(255)                                         |
| other         | other          | 字符串   | 默认                                                | varchar(255)                                         |
| status        | 状态           | 数值     | 1:启用 0:禁用                                       | tinyint(4) DEFAULT 1                                 |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |

---
## 用户详情实体(`user_detail`)

用户详情
该内容未完,可进行扩展处理

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL, primary,fk_user_detail->user.id    |
| nickname      | 昵称           | 字符串   |                                                     | varchar(64)                                          |
| avatar        | 头像           | 字符串   |                                                     | varchar(255)                                         |
| mfa_secret    | MFA密钥        | 字符串   |                                                     | varchar(1024)                                        |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |

---
## 员工详情实体(`user_employee`)


| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL, primary,fk_user_employee->user.id  |
| nickname      | 昵称           | 字符串   |                                                     | varchar(64)                                          |
| avatar        | 头像           | 字符串   |                                                     | varchar(255)                                         |
| mfa_secret    | MFA密钥        | 字符串   |                                                     | varchar(1024)                                        |
| deleted       | 逻辑删除       | 数值     | 用户不能删除,但是员工可以逻辑删除                   | tinyint(4) DEFAULT 0                                 |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |

---
## 顾客详情实体(`user_customer`)



| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL, primary,fk_user_customer->user.id  |
| nickname      | 昵称           | 字符串   |                                                     | varchar(64)                                          |
| avatar        | 头像           | 字符串   |                                                     | varchar(255)                                         |
| mfa_secret    | MFA密钥        | 字符串   |                                                     | varchar(1024)                                        |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |

---
## 用户消息实体(`user_message`)

主要用户系统通知

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| from_id       | 发送消息       | 字符串   |                                                     | int(64), fk_u_msg_from_id->user.id                   |
| to_id         | 发送消息       | 字符串   |                                                     | int(64), fk_u_msg_to_id->user.id                     |
| kid           | 索引           | 字符串   |                                                     | varchar(64), udx_user_message_kid                    |
| avatar        | 头像           | 字符串   |                                                     | varchar(255)                                         |
| title         | 标题           | 字符串   |                                                     | varchar(255)                                         |
| datetime      | 日期           | 字符串   |                                                     | timestamp                                            |
| type          | 类型           | 字符串   |                                                     | varchar(16)                                          |
| read          | 已读           | 数值     |                                                     | tinyint(4)                                           |
| description   | 描述           | 字符串   |                                                     | TEXT                                                 |
| clickClose    | 关闭           | 数值     |                                                     | tinyint(4)                                           |
| status        | 状态           | 数值     |                                                     | tinyint(4)                                           |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |

---
## 第三方消息实体(`oauth2_message`)


| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |

---
## 第三方消息转发(forward)实体(`oauth2_message_next`)


| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |

---
