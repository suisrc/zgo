# 数据库

```sql
PRIMARY KEY (`id`)
FOREIGN KEY fk_key(`xxx_id`)
REFERENCES xxx(`id`)
INDEX index_name (title(length))
UNIQUE index_name (title(length))
```
primary: 主键  

udx_xxx: 唯一索引  
idx_xxx: 索引  

fk_xxxx: 外键  
fk_account_user->user.id  

```sql model
ARG tbl=zgo_

includes=
excludes=
```
"| -" 标识注释,该行的内容会被忽略
## 账户实体(`account`)

管理用户登陆控制,oauth2_token令牌为用户令牌, 与服务器令牌需要区别
同一个用户可以具有多个账户实体,每一种账户实体代表用户的一种登陆方式
用户每次绑定一个第三方账户,在实体中就会增加一条该用户的账户
当前用户如果绑定用户名,邮箱,手机登陆,意味着该用户具有3个本地实体
密码加密方式, password_type -> MD5和SHA1是一种依赖MD5和SHA1的自定义变种加密方式, BCR是标准的bcrypt加密,BCR2和BCR3是对盐值进行了加密
BCR2 -> 对salt进行了简单的倒序处理, BCR3 -> 对salt进行了以hashpassword为基础的位运算加密,不会影响其执行速度, 注意,其可以基于本身进行解密处理
经过测试, MD5和SHA1 -> 0.170s/万次, BCR -> 667s/万次, MD5和SHA1的执行效率大约是BCR的4000~5000倍, 在非必要请求下,请使用MD5或者SHA1

在系统中domain通常指的是域名, 用于区分子应用. 而架构中的域, 一般指的是领域, 这里通常指的是机构域, 即organization -> org_code

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | --------------------------------------------------- | ---------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| pid           | 上级账户       | 数值     | 当前账户验证密码的方式为PID时候,可使用上级账户验证  | int(11)                                              |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| account       | 账户           | 字符串   | 账户和账户类型和账户归属平台构成唯一标识            | varchar(255) NOT NULL, udx_account                   |
| account_type  | 账户类型       | 数值     | 1:name 2:mobile 3:email 4:openid 5:unionid 6:token  | tinyint(4) DEFAULT '1', udx_account                  |
| platform_bid  | 账户归属平台   | 数值     | 被授权平台, NULL标识不归属任何平台                  | varchar(64), udx_account,fk_platform_bid->platform.id |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| user_id       | 用户标识       | 数值     |                                                     | int(11) NOT NULL, fk_account_user_id->user.id        |
| org_id        | 组织标识       | 数值     | 如果不为空,表示账户和组织绑定                       | int(11), fk_account_org_id->organization.id          |
| role_id       | 角色标识       | 数值     | 如果不为空,表示账户和角色绑定                       | int(11), fk_account_role_id->user_role.id            |
| client_id     | 客户端         | 数值     | 如果不为空,表示账户和应用绑定                       | int(11), fk_account_client_id->client.id             |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| password      | 登录密码       | 字符串   | 1.密码, 2:签名密钥 3:密钥 4:密钥                    | varchar(255)                                         |
| password_salt | 密码盐值       | 字符串   | 加密规则加固, 防止暴力破解                          | varchar(255)                                         |
| password_type | 密码方式       | 字符串   | 1:(明文) 2:MD5 3:SHA1 4: BCR 5: BCR2 6: BCR3        | varchar(16)                                          |
| verify_secret | 校验密钥       | 字符串   | SMS 和 OAUTH2 验证时候,对状态进行签名               | varchar(255)                                         |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| status        | 状态           | 数值     | 1:启用 0:禁用 2: 未激活                             | tinyint(4) DEFAULT 1                                 |
| description   | 账户描述       | 字符串   |                                                     | varchar(255)                                         |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |

---
## 第三方登陆实体(`platform`)

用于第三方授权登陆我们的系统

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| kid           | 三方标识       | 字符串   |                                                     | varchar(64)  NOT NULL, udx_oauth2_platform_kid       |
| type          | 平台标识       | 字符串   | 1:WX 2:TB 3:JD 4:GITEA 5: WXQ 6...                  | varchar(32) NOT NULL                                 |
| org_id        | 组织标识       | 数值     | 如果不为空,表示账户和组织绑定                       | int(11), fk_platform_org_id->organization.id         |
| signin        | 可登陆         | 数值     | 1:启用 0:禁用                                       | tinyint(4) DEFAULT 0                                 |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| avatar        | 平台头像       | 字符串   |                                                     | varchar(255)                                         |
| status        | 状态           | 数值     | 1:启用 0:禁用                                       | tinyint(4) DEFAULT 1                                 |
| description   | 平台描述       | 字符串   |                                                     | varchar(255)                                         |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| app_id        | 应用标识       | 字符串   |                                                     | varchar(128)                                         |
| app_secret    | 应用密钥       | 字符串   |                                                     | varchar(1024)                                        |
| agent_id      | 代理商标识     | 字符串   |                                                     | varchar(128)                                         |
| agent_secret  | 代理商密钥     | 字符串   |                                                     | varchar(1024)                                        |
| suite_id      | 套件标识       | 字符串   |                                                     | varchar(128)                                         |
| suite_secret  | 套件密钥       | 字符串   |                                                     | varchar(1024)                                        |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| authorize_url | 认证地址       | 字符串   |                                                     | varchar(1024)                                        |
| token_url     | 令牌地址       | 字符串   |                                                     | varchar(1024)                                        |
| profile_url   | 个人资料地址   | 字符串   |                                                     | varchar(1024)                                        |
| signin_url    | 重定向回调地址 | 字符串   | 上游应用无法获取https时候替代方案                   | varchar(128)                                         |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| js_secret     | javascript密钥 | 字符串   | 需要js签名认证时候,进行认证的key                    | varchar(255)                                         |
| state_secret  | 回调state密钥  | 字符串   | 缓存处理state,用密钥计算state具有更好的分布式       | varchar(255)                                         |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| callback      | 是否支持回调   | 数值     |                                                     | tinyint(4) DEFAULT 0                                 |
| cb_domain     | 默认域名       | 字符串   |                                                     | varchar(128)                                         |
| cb_scheme     | 默认协议       | 字符串   |                                                     | varchar(16) DEFAULT 'https'                          |
| cb_encrypt    | 回调是否加密   | 数值     |                                                     | tinyint(4) DEFAULT 0                                 |
| cb_token      | 加密令牌       | 字符串   |                                                     | varchar(255)                                         |
| cb_encoding   | 加密编码       | 字符串   |                                                     | varchar(255)                                         |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |

---
## 第三方授权实体(`client`)

我们的系统提供第三方登陆, 系统中不涉及第三方签发的令牌, 用户可以直接通过jwt访问我们系统
注意:如果用户签发的令牌具有audience权限,需要限定其使用, 可以在网关配置中增加jwt验证权限,拒绝该请求
如果audience为空,标识全平台通用,注意,对于多系统来说,不要使用签发后的内容为hostname, issuer如果为空,签发后为hostname

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| kid           | 客户端标识     | 字符串   | jwt的header[kid], 请求未指定看audience              | varchar(64)  NOT NULL, udx_oauth2_client_kid         |
| secret        | 客户端密钥     | 字符串   | 主要用于应用间通信                                  | varchar(1024)                                        |
| domain        | 客户端域名     | 字符串   | 用于跳转或者登录授权                                | varchar(255)                                         |
| org_id        | 组织标识       | 数值     | 如果不为空,表示账户和组织绑定                       | int(11), fk_client_org_id->organization.id         |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| jwt_audience  | 令牌接受平台   | 字符串   |                                                     | varchar(255)                                         |
| jwt_issuer    | 令牌签发平台   | 字符串   |                                                     | varchar(255)                                         |
| jwt_expired   | 令牌有效期     | 数值     | 7200                                                | int(11) DEFAULT 7200                                 |
| jwt_type      | 令牌类型       | 数值     | JWT 不可修改                                        | varchar(32) DEFAULT 'JWT'                            |
| jwt_method    | 令牌方法       | 字符串   | HS512 不可修改                                      | varchar(32) DEFAULT 'HS512'                          |
| jwt_secret    | 令牌密钥       | 字符串   | signing secret                                      | varchar(255) NOT NULL                                |
| jwt_getter    | 令牌获取方法   | 字符串   | 1.header(authorization) 2.query(token)              | varchar(32)                                          |
| -             |                |          | 3.cookie(authorization) (备用字段)                  |                                                      |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| signin_url    | 登陆地址       | 字符串   | 未指定redirect时候,默认的跳转地址， 默认为domain    | varchar(2048)                                        |
| signin_check  | 登陆确认       | 数值     | false, 登陆是否需要确认                             | tinyint(4) DEFAULT 0                                 |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| status        | 状态           | 数值     | 1:启用 0:禁用                                       | tinyint(4) DEFAULT 1                                 |
| delete        | 删除标识       | 数值     | 1:删除 0:正常                                       | tinyint(4) DEFAULT 0                                 |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |


---
## 通信令牌实体(`token`)

使用的令牌,为我服务器使用令牌与其他服务器通信的记录,也可用于集群中应用对第三方服务器访问的信息共享

第三方授权实体, 用户完成授权后,需要处理令牌,选择授权系统
已知: 
A用户:  [host]          请求域
        [client]            应用ID
B角色:  [Role.domain]       角色域
C应用:  [Client.kid]        应用ID
        [Client.audience]   接受域
约束:
0.[Client]为空, 通过[host]确认[Client], 如果存在多个,随机选择
1.[Client]为空, [Role.domain]必须为空或者等于[host]
2.[Client.audience]不为空, 必须等于[host]
3.[Role.domain]为空, 直接返回true, 该角色为全平台角色 
4.[Client.audience]不为空, 必须等于[Role.domain]需要匹配
5.验证[Role.domain]和[host]

角色约束:
1.如果当前账户的角色可以授权,直接授权
2.如果该用户具有单角色,登陆的子系统没有角色,则放弃授权
3.如果具有多角色,优先使用上次登陆的角色登陆系统, 如果上次的角色被剥夺或者第一次登陆的情况使用第四条规则
4.选择第一角色直接授权,并提供角色选择接口

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| token_bid     | 令牌归属       | 数值     |                                                     | int(11),     idx_token_id                            |
| token_type    | 令牌类型       | 字符串   | 标记令牌的类型(account, platform)                   | varchar(32), idx_token_id                            |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| token_kid       | 角色标识     | 字符串   |                                                     | varchar(64), idx_token_tkid                          |
| access_token    | 访问令牌     | 字符串   |                                                     | varchar(1024)                                        |
| access_expires  | 访问令牌     | 数值     |                                                     | int(11) DEFAULT 7200                                 |
| refresh_token   | 刷新令牌     | 字符串   |                                                     | varchar(255)                                         |
| refresh_expires | 刷新令牌     | 数值     |                                                     | int(11) DEFAULT 604800                               |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| call_mode     | 调用方式       | 字符串   | 1:signin 2:refresh 3:oauth2                         | varchar(16) DEFAULT 'signin'                         |
| call_count    | 调用次数       | 数值     | 令牌被使用的次数, 注意开发时需要降低更新频次        | int(11) DEFAULT 0                                    |
| sync_lock     | 同步锁         | 数值     | 同步锁,使用时间锁,防止死锁                          | int(11)                                              |
| refresh_count | 刷新次数       | 数值     |                                                     | int(11) DEFAULT 0                                    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| user_id       | 用户标识       | 数值     |                                                     | int(11) NOT NULL, fk_token_user_id->user.id          |
| org_id        | 组织标识       | 数值     | 如果不为空,表示账户和组织绑定                       | int(11), fk_token_org_id->organization.id            |
| role_id       | 角色标识       | 数值     | 如果不为空,表示账户和角色绑定                       | int(11), fk_token_role_id->user_role.id              |
| client_id     | 客户端         | 数值     | 如果不为空,表示账户和应用绑定                       | int(11), fk_token_client_id->client.id               |
| last_ip       | 上次登陆IP     | 字符串   |                                                     | varchar(64)                                          |
| last_at       | 上次登陆时间   | 时间格式 |                                                     | timestamp                                            |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| error_code    | 异常类型       | 字符串   | 不为空， 禁止使用                                   | varchar(64)                                          |
| error_message | 异常信息       | 字符串   | 系统拦截异常                                        | varchar(255)                                         |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |

---
## 用户实体(`user`)

用户实体操作非常频繁,所以,其中的内容应该尽可能保存的少,更多详细信息可以通过detail进行保存
我们可以看到该实体没有共同字段,理由是共同字段可以通过detail得到,所以对于user实体无需共同字段
该内容未完,可进行扩展处理

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| kid           | 唯一标识       | 字符串   | 主要注意屏蔽系统中的id                              | varchar(64), udx_user_kid                            |
| type          | 账户类型       | 字符串   | usr(用户), org(组织), app(应用)                     | varchar(64)  idx_user_type                           |
| name          | 用户名         | 字符串   |                                                     | varchar(64), idx_user_name                           |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| status        | 状态           | 数值     | 1:启用 0:禁用 2: 未激活                             | tinyint(4) DEFAULT 1                                 |
| delete        | 删除标识       | 数值     | 1:删除 0:正常  (用户是否被销户)                     | tinyint(4) DEFAULT 0                                 |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |

---
## 用户详情实体(`user_detail`)

用户详情

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL, primary,fk_user_detail_id->user.id |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| avatar        | 头像           | 字符串   |                                                     | varchar(255)                                         |
| nickname      | 昵称           | 字符串   |                                                     | varchar(255)                                         |
| description   | 个人描述       | 字符串   |                                                     | varchar(255)                                         |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |


## 组织实体(`organization`)

组织实体
组织本身是用户的一个实体， 也是用户的一个集合
组织也会存在user_detail内容， 因为系统允许用户已组织账户登录

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL, primary,fk_organization_id->user.id |
| code          | 唯一标识       | 字符串   |                                                     | varchar(255)  NOT NULL, udx_organization_code        |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |


---
## 用户确认用户唯一性的方式(`user_union_t`)

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| kid           | 用户唯一标识   | 字符串   | 系统生成                                            | varchar(255), udx_user_union_t_kid                   |
| uid           | 用户唯一标识   | 字符串   | 第三方系统提供的用户唯一标识                        | varchar(255), udx_user_union_t_uid                   |
| uid_type      | 验证方式       | 字符串   | 人归一时，验证用户归一方式                          | varchar(64), udx_user_union_t_uid                    |
| user_id       | 用户ID         | 数值     |                                                     | int(11) NOT NULL, fk_user_union_t_uid->user.id       |
| account_id    | 账户ID         | 数值     | 人归一时，使用账户ID归一                            | int(11), fk_user_union_t_aid->account.id             |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| org_code      | 组织标识       | 字符串   |                                                     | varchar(255), udx_user_union_t_kid, fk_user_union_t_roc->role.org_code |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |


---
## 子应用用户(`user_client_t`)

用户对应子系统内容


| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| akid          | 用户唯一标识   | 字符串   | akid, ckid为用户唯一在该表中的唯一标识              | varchar(64), udx_user_client_kid                     |
| ctid          | 应用唯一标识   | 字符串   |                                                     | int(11), udx_user_client_kid, fk_user_client_kid->oauth2_client.id |
| unid          | 用户唯一标识   | 数值     |                                                     | int(11), fk_user_client_union_id->user.id            |
| user_id       | 用户ID         | 数值     |                                                     | int(11) NOT NULL, fk_user_client_uid->user.id        |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| status        | 状态           | 数值     | 1:启用 0:禁用 2: 未激活                             | tinyint(4) DEFAULT 1                                 |
| delete        | 删除标识       | 数值     | 1:删除 0:正常  (用户是否被销户)                     | tinyint(4) DEFAULT 0                                 |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |


---
## 用户组织实体(`user_org_t`)

员工详情
该内容未完,可进行扩展处理
内容暂时处于保留方式

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL, primary,fk_user_employee->user.id  |
| kid           | 唯一标识       | 字符串   |                                                     | varchar(64), udx_user_employee_kid                   |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| nickname      | 昵称           | 字符串   |                                                     | varchar(64)                                          |
| avatar        | 头像           | 字符串   |                                                     | varchar(255)                                         |
| deleted       | 逻辑删除       | 数值     | 用户不能删除,但是员工可以逻辑删除                   | tinyint(4) DEFAULT 0                                 |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| org_code      | 组织标识       | 字符串   | 冗余辅助字段，角色中包含org_code                    | varchar(64), fk_user_employee_roc->role.org_code     |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |

---
## 用户安全(`user_security`)

用户实体操作非常频繁,所以,其中的内容应该尽可能保存的少,更多详细信息可以通过detail进行保存
我们可以看到该实体没有共同字段,理由是共同字段可以通过detail得到,所以对于user实体无需共同字段
该内容未完,可进行扩展处理

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     | 同 user_id                                          | int(11) NOT NULL, primary,fk_user_security->user.id  |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| mfa           | mfa密钥        | 字符串   | Multi-Factor Authentication (MFA)                   | varchar(1024)                                        |
| phone         | 密保电话       | 字符串   | 不同于登陆手机号,是独立手机号,以保证账户安全        | varchar(32)                                          |
| email         | 备用邮箱       | 字符串   | 不同于登陆邮箱,是独立邮箱,以保证账户安全            | varchar(128)                                         |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |


---
## 角色实体(`role`)

一个用户登陆系统后,只能有一个角色存在,如果有多角色的情况,需要进行选择
本质上角色是没有域的概念的,但是为了方便管理,所以证件域的选项

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| kid           | 唯一标识       | 字符串   | 主要注意屏蔽系统中的id                              | varchar(64), udx_role_kid                            |
| name          | 角色名         | 字符串   |                                                     | varchar(64), udx_role_name                           |
| status        | 状态           | 数值     | 1:启用 0:禁用                                       | tinyint(4) DEFAULT 1                                 |
| domain        | 域             | 字符串   | 角色域, 多系统账户来说,角色应该是跨域的             | varchar(255)                                         |
| admin         | 管理员         | 数值     | 1:是管理员 0:不是管理员， 管理员为非继承字段        | tinyint(4) DEFAULT 1                                 |
| description   | 角色描述       | 字符串   |                                                     | varchar(255)                                         |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| org_code      | 组织标识       | 字符串   | 角色的名字， 对于同一个组织来说是唯一的             | varchar(255), udx_role_name                          |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |

---
## 角色角色实体(`role_role`)

角色赋值时候,可能出现环,所以在保存角色时候,需要对角色进行校验,防止环形角色情况发生
角色中,会出现递归授权的问题,如何做到角色快速可达,是一个问题, 不过我们可以通过[Enforcer.GetImplicitRolesForUser]快速获取用户的角色列表

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| pid           | 父节点标识     | 数值     |                                                     | int(11), fk_role_role_pid->role.id                   |
| cid           | 子节点标识     | 数值     |                                                     | int(11), fk_role_role_cid->role.id                   |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| org_code      | 组织标识       | 字符串   | 冗余辅助字段，角色中包含org_code                    | varchar(64), fk_role_role_roc->role.org_code         |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |

---
## 用户角色实体(`user_role`)

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| uid           | 账户标识       | 数值     |                                                     | int(11), fk_role_user_id->user.id                    |
| rid           | 角色标识       | 数值     |                                                     | int(11), fk_role_role_id->role.id                    |
| expired       | 授权有效期     | 时间格式 |                                                     | int(11)                                              |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| org_code      | 组织标识       | 字符串   | 冗余辅助字段，角色中包含org_code                    | varchar(64), fk_user_role_roc->role.org_code         |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |

---
## 资源实体(`gateway`)

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| kid           | 唯一标识       | 字符串   |                                                     | varchar(64), udx_gateway_kid                         |
| name          | 资源名         | 字符串   | 资源名可以重复, 即该资源标识一类资源而不是单独      | varchar(64), udx_gateway_name                        |
| domain        | 域名           | 字符串   | api.io                                              | varchar(255)                                         |
| methods       | 方法           | 字符串   | (GET)(POST)(PUT)(DELETE)                            | varchar(64)                                          |
| path          | 路径           | 字符串   | /api/*                                              | varchar(255)                                         |
| netmask       | 网络掩码       | 字符串   | 0.0.0.0/0                                           | varchar(64)                                          |
| allow         | 允许vs拒绝     | 数值     | 1: allow 0:deny                                     | tinyint(4)                                           |
| status        | 状态           | 数值     | 1:启用 0:禁用                                       | tinyint(4) DEFAULT 1                                 |
| description   | 描述           | 字符串   |                                                     | varchar(255)                                         |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| org_code      | 组织标识       | 字符串   | 冗余辅助字段，角色中包含org_code                    | varchar(64), udx_gateway_name,fk_gateway_roc->role.org_code |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |

---
## 资源角色实体(`role_gateway`)

这里使用资源角色而非角色资源,是为了兼容casbin方式,我们对资源如下定义:
资源是一类请求资源的合集,而非一个.请求资源有唯一标识,但是资源没有,角色和资源绑定.

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| rid           | 角色           | 数值     |                                                     | int(11), fk_role_gateway_rid->role.id                |
| gid           | 资源           | 数值     |                                                     | int(11), fk_role_gateway_gid->gateway.id             |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| org_code      | 组织标识       | 字符串   | 冗余辅助字段，角色中包含org_code                    | varchar(64), fk_role_gateway_roc->role.org_code      |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |

---
## 资源角色实体(`user_gateway`)

用于对某一个用户进行单独屏蔽操作, 非特殊情况下不推荐使用

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| uid           | 用户           | 数值     |                                                     | int(11), fk_user_gateway_uid->user.id                |
| gid           | 资源           | 数值     |                                                     | int(11), fk_user_gateway_gid->gateway.id             |
| expired       | 授权有效期     | 时间格式 |                                                     | int(11)                                              |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| org_code      | 组织标识       | 字符串   | 冗余辅助字段，角色中包含org_code                    | varchar(64), fk_user_gateway_roc->role.org_code      |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |

---
## 系统标签实体(`tag_system`)

系统标签可直接被删除

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| type          | 标签类型       | 字符串   | 1:用户 2:角色 3:资源 4:平台 5:客户端                | varchar(64), udx_tag_system                          |
| bid           | 归属id         | 数值     |                                                     | int(11), udx_tag_system                              |
| tag           | 标签           | 字符串   |                                                     | varchar(64), udx_tag_system                          |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |

---
## 通用标签实体(`tag_custom`)

不可直接删除,但是可以通过逻辑删除标识删除,自定义标签为一种随意标签,本身不会影响系统运行,但是可以提供筛选条件,用于分析用户等行为

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| type          | 标签类型       | 字符串   | 1:用户 2:角色 3:资源 4:平台 5:客户端                | varchar(64), udx_tag_custom                          |
| bid           | 归属id         | 数值     |                                                     | int(11), udx_tag_custom                              |
| tag           | 标签           | 字符串   |                                                     | varchar(64), udx_tag_custom                          |
| deleted       | 删除标识       | 字符串   | false                                               | tinyint(4) DEFAULT 0                                 |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |

---
## 国际化实体(`i18n_language`)

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| mid           | message id     | 字符串   |                                                     | varchar(255), udx_i18n_message_id                    |
| lang          | 语言           | 字符串   | zh-CN, en-US                                        | varchar(16), udx_i18n_message_id                     |
| description   | 描述           | 字符串   |                                                     | varchar(64)                                          |
| left_delim    | 定界符         | 字符串   | 左边模板定界符                                      | varchar(16)                                          |
| right_delim   | 定界符         | 字符串   | 右边模板定界符                                      | varchar(16)                                          |
| zero          | zero           | 字符串   |                                                     | varchar(255)                                         |
| one           | one            | 字符串   |                                                     | varchar(255)                                         |
| two           | two            | 字符串   |                                                     | varchar(255)                                         |
| few           | few            | 字符串   |                                                     | varchar(255)                                         |
| many          | many           | 字符串   |                                                     | varchar(255)                                         |
| other         | other          | 字符串   | 默认                                                | varchar(255)                                         |
| status        | 状态           | 数值     | 1:启用 0:禁用                                       | tinyint(4) DEFAULT 1                                 |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |
