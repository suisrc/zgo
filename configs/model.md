# 数据库

```sql
PRIMARY KEY (`id`)
FOREIGN KEY fk_key(`xxx_id`)
REFERENCES xxx(`id`)
INDEX index_name (title(length))
UNIQUE index_name (title(length))
```
primary: 主键  

udx_xxx: 唯一索引  
idx_xxx: 索引  

fk_xxxx: 外键  
fk_account_user->user.id  

```sql model
ARG tbl=zgo_

includes=
excludes=
```
"| -" 标识注释,该行的内容会被忽略
## 账户实体(`account`)

管理用户登陆控制,oauth2_token令牌为用户令牌, 与服务器令牌需要区别
同一个用户可以具有多个账户实体,每一种账户实体代表用户的一种登陆方式
用户每次绑定一个第三方账户,在实体中就会增加一条该用户的账户
当前用户如果绑定用户名,邮箱,手机登陆,意味着该用户具有3个本地实体
密码加密方式, password_type -> MD5和SHA1是一种依赖MD5和SHA1的自定义变种加密方式, BCR是标准的bcrypt加密,BCR2和BCR3是对盐值进行了加密
BCR2 -> 对salt进行了简单的倒序处理, BCR3 -> 对salt进行了以hashpassword为基础的位运算加密,不会影响其执行速度, 注意,其可以基于本身进行解密处理
经过测试, MD5和SHA1 -> 0.170s/万次, BCR -> 667s/万次, MD5和SHA1的执行效率大约是BCR的4000~5000倍, 在非必要请求下,请使用MD5或者SHA1

在系统中domain通常指的是域名, 用于区分子应用. 而架构中的域, 一般指的是领域, 这里通常指的是机构域, 即tenant

注意， name账户只允许使用[a-z0-9_-.]， phone账户只允许使用[0-9-], 邮箱账户只允许使用[a-z0-9_-.]和唯一[@]

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | --------------------------------------------------- | ---------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| pid           | 上级账户       | 数值     | 当前账户验证密码的方式为PID时候,可使用上级账户验证  | int(11), fk_account_pid->account.id                  |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| account       | 账户           | 字符串   | 账户和账户类型和账户归属平台构成唯一标识            | varchar(255) NOT NULL, udx_account                   |
| account_type  | 账户类型       | 数值     | 1:name 2:phone 3:email 4:openid 5:unionid 6:token   | tinyint(4) DEFAULT '1', udx_account                  |
| platform_kid  | 账户归属平台   | 字符串   | 被授权平台, NULL标识不归属任何平台                  | varchar(64), udx_account,fk_account_platform_kid->platform.kid |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| user_id       | 用户标识       | 数值     |                                                     | int(11) NOT NULL, fk_account_user_id->user.id        |
| role_id       | 角色标识       | 数值     | 如果不为空,表示账户和角色绑定                       | int(11), fk_account_role_id->user_role.id            |
| org_cod       | 租户标识       | 字符串   | 如果不为空,表示账户和租户绑定                       | varchar(64), fk_account_org_cod->tenant.code         |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| password      | 登录密码       | 字符串   | 1.密码, 2:签名密钥 3:密钥 4:密钥                    | varchar(255)                                         |
| password_salt | 密码盐值       | 字符串   | 加密规则加固, 防止暴力破解                          | varchar(255)                                         |
| password_type | 密码方式       | 字符串   | 1:(明文) 2:MD5 3:SHA1 4: BCR 5: BCR2 6: BCR3        | varchar(16)                                          |
| verify_secret | 校验密钥       | 字符串   | SMS 和 OAUTH2 验证时候,对状态进行签名               | varchar(255)                                         |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| status        | 状态           | 数值     | 1:启用 0:禁用 2: 未激活 3: 注销                     | tinyint(4) DEFAULT 1                                 |
| description   | 账户描述       | 字符串   |                                                     | varchar(255)                                         |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |

---
## 用户实体(`user`)

用户包括人员和租户， 人归一， 所以人员没有归属， 但是人员可以通过org发生归属
对于个体户来说， 门店就是租户， 但是对于连锁企业来说， 门店应该具有租户归属

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| pid           | 用户归属       | 字符串   |                                                     | int(11), fk_user_pid->user.id                        |
| kid           | 唯一标识       | 字符串   | usr(48),   org(32),   app(24),   sto(32)            | varchar(64) NOT NULL, udx_user_kid                   |
| type          | 账户类型       | 字符串   | usr(用户), org(租户), app(应用), sto(门店)          | varchar(64) NOT NULL DEFAULT 'usr', idx_user_type    |
| name          | 用户名         | 字符串   |                                                     | varchar(64) NOT NULL, idx_user_name                  |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| status        | 状态           | 数值     | 1:启用 0:禁用 2: 未激活 3:作废 4:合并               | tinyint(4) DEFAULT 1                                 |
| delete        | 删除标识       | 数值     | 1:删除 0:正常  (用户是否被销户)                     | tinyint(4) DEFAULT 0                                 |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |

---
## 用户详情实体(`user_detail`)

用户详情
用户实体操作非常频繁,所以,其中的内容应该尽可能保存的少,更多详细信息可以通过detail进行保存
我们可以看到该实体没有共同字段,理由是共同字段可以通过detail得到,所以对于user实体无需共同字段

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL, primary,fk_user_detail_id->user.id |
| avatar        | 头像           | 字符串   |                                                     | varchar(255)                                         |
| description   | 个人描述       | 字符串   |                                                     | varchar(255)                                         |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |

---
## 用户安全实体(`user_security`)

用户实体操作非常频繁,所以,其中的内容应该尽可能保存的少,更多详细信息可以通过detail进行保存
我们可以看到该实体没有共同字段,理由是共同字段可以通过detail得到,所以对于user实体无需共同字段
该内容未完,可进行扩展处理

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     | 同 user_id                                          | int(11) NOT NULL, primary,fk_user_security->user.id  |
| mfa13         | mfa密钥        | 字符串   | Multi-Factor Authentication (MFA)                   | varchar(1024)                                        |
| phone         | 密保电话       | 字符串   | 不同于登陆手机号,是独立手机号,以保证账户安全        | varchar(32)                                          |
| email         | 备用邮箱       | 字符串   | 不同于登陆邮箱,是独立邮箱,以保证账户安全            | varchar(128)                                         |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |

---
## 人员实体(`person`)

人员基本属性

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL, primary,fk_person_id->user.id      |
| unique_name   | 唯一用户名     | 字符串   |                                                     | varchar(64) NOT NULL, udx_person_unique_name         |
| first_name    | 用户名         | 字符串   |                                                     | varchar(32)                                          |
| last_name     | 用户名         | 字符串   |                                                     | varchar(32)                                          |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| org_cod       | 租户ID         | 字符串   | 租户构建的账户，暂时可能无法处理归属问题            | varchar(64), fk_person_org_cod->tenant.code          |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |

---
## 租户/组织/机构实体(`tenant`)

tenant

租户基本属性， 
注意：
User-Xid=1,                可以认为是平台初始账户，不受权限管控，全局只有一个账户由此特权， 生成环境完成配置后可以禁用该账户
Org-Code="P6M"(platform)， 可以认为是归属平台的账户

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL, primary,fk_tenant_id->user.id      |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| code          | 租户标识       | 字符串   |                                                     | varchar(64) NOT NULL, udx_tenant_code                |
| hosted        | 租户被托管     | 数值     | 1:启用 0:禁用                                       | tinyint(4) DEFAULT 0                                 |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |


---
## 门店账户(`store`)

由于一个门店大部分情况不会归属2个租户， 但是个例情况下会发生， 所以如果做店归一， 需要门店租户表， 但是tenant_user可以提供store -> tenant关联关系
所以这里的org_cod有点多余， 但是为了提供一种快速定位的方法， 暂时保留org_cod字段， 如果org_cod不为空， 标识门店归属不存在争议， 否则存在争议通过tenant_user解决争议

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL, primary,fk_store_id->user.id       |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| org_cod       | 门店归属机构   | 字符串   |                                                     | varchar(64) NOT NULL, fk_store_org_cod->tenant.code  |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |

---
## 租户用户主键(`tenant_user`)

人员归属租户产生的联合ID

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| user_id       | 用户ID         | 数值     |                                                     | int(11) NOT NULL, primary,fk_org_user_uid->user.id |
| org_cod       | 租户ID         | 字符串   |                                                     | varchar(64) NOT NULL, primary,udx_org_user_union_kid,udx_org_user_name,fk_org_user_ocd->tenant.code |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| union_kid     | 唯一标识       | 字符串   | 组织下唯一id                                        | varchar(64) NOT NULL, udx_org_user_union_kid         |
| name          | 用户名         | 字符串   | 默认同unid                                          | varchar(64) NOT NULL, udx_org_user_name              |
| custom_id     | 唯一标识       | 字符串   | 组织自定义id                                        | varchar(255)                                         |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| status        | 状态           | 数值     | 1:启用 0:禁用 2: 未激活, 3: 销户                    | tinyint(4) DEFAULT 1                                 |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |

---
## 人归一方式(`user_union`)

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| pid           | 唯一标识       | 数值     | 归一依赖                                            | int(11), fk_user_union_pid->user_union.id            |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| org_cod       | 租户ID         | 字符串   |                                                     | varchar(64), fk_user_union_org_cod->tenant.code |
| user_id       | 用户ID         | 数值     |                                                     | int(11) NOT NULL, fk_user_union_user_id->user.id     |
| type          | 归一方式       | 字符串   | 人归一时，验证用户归一方式                          | varchar(64)  NOT NULL, idx_user_union_type           |
| type_id       | 归一标识       | 字符串   | 人归一时，验证用户归一主键                          | varchar(255), idx_user_union_type_id                 |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |

---
## 策略服务实体(`app_service`)

服务是平台提供的服务

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| name          | 服务名称       | 字符串   |                                                     | varchar(64)                                          |
| code          | 服务编码       | 字符串   |                                                     | varchar(64), udx_app_service_code                    |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| status        | 状态           | 数值     | 1:启用 0:禁用 2:未激活                              | tinyint(4) DEFAULT 1                                 |
| description   | 描述           | 字符串   |                                                     | varchar(255)                                         |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |

---
## 策略服务实体(`app_service_org`)

租户被授权的服务列表

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| svc_id        | 服务标识       | 数值     |                                                     | int(11) NOT NULL, primary,fk_app_service_org_sid->app_service.id |
| org_cod       | 租户标识       | 字符串   |                                                     | varchar(64) NOT NULL, primary,fk_app_service_org_orcd->tenant.code |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| expired       | 授权有效期     | 时间格式 |                                                     | timestamp                                            |
| status        | 状态           | 数值     | 1:启用 0:禁用 2:未激活 3: 删除 4: 欠费 5: 到期      | tinyint(4) DEFAULT 1                                 |
| description   | 描述           | 字符串   |                                                     | varchar(255)                                         |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |

---
## 策略服务受众实体(`app_service_audience`)

一个受众域同事只能归于一个服务， 这就意味这该表的audience具有唯一性
使用该表可以将访问域名转换为服务名称， domain/path => audience/resource -> sid => service.id -> service.code

确认用户方位的服务器
1.domain + /path1/path2/ 确认访问的系统
2.domain 确认访问的系统
3./path1/path2/ 确认访问的系统
如果都无法查询到， 需要访问的系统不存在，禁止访问

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| svc_id        | 服务标识       | 数值     |                                                     | int(11) NOT NULL, fk_app_service_audience_sid->app_service.id |
| org_cod       | 租户标识       | 字符串   |                                                     | varchar(64), fk_app_service_audience_ocd->tenant.code |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| audience      | 受众域         | 字符串   | 绑定服务                                            | varchar(255), udx_app_service_audience               |
| resource      | 受众源         | 字符串   | 绑定服务                                            | varchar(255), udx_app_service_audience               |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| status        | 状态           | 数值     | 1:启用 0:禁用 2:未激活                              | tinyint(4) DEFAULT 1                                 |
| description   | 描述           | 字符串   |                                                     | varchar(255)                                         |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |

---

## 服务实体(`app_client`)

为第三方应用授权

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| kid           | 客户端标识     | 字符串   | jwt的header[kid], 请求未指定看audience              | varchar(64)  NOT NULL, udx_app_client_kid            |
| secret        | 客户端密钥     | 字符串   | 主要用于应用间通信                                  | varchar(1024)                                        |
| org_cod       | 租户标识       | 数值     | 如果不为空,表示账户和租户绑定                       | int(11), fk_app_client_org_cod->tenant.id            |
| status        | 状态           | 数值     | 1:启用 0:禁用                                       | tinyint(4) DEFAULT 1                                 |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| jwt_audience  | 令牌接受平台   | 字符串   |                                                     | varchar(255)                                         |
| jwt_issuer    | 令牌签发平台   | 字符串   |                                                     | varchar(255)                                         |
| jwt_expired   | 令牌有效期     | 数值     | 7200                                                | int(11) DEFAULT 7200                                 |
| jwt_type      | 令牌类型       | 数值     | JWT 不可修改                                        | varchar(32) DEFAULT 'JWT'                            |
| jwt_method    | 令牌方法       | 字符串   | HS512 不可修改                                      | varchar(32) DEFAULT 'HS512'                          |
| jwt_secret    | 令牌密钥       | 字符串   | signing secret                                      | varchar(255) NOT NULL                                |
| jwt_getter    | 令牌获取方法   | 字符串   | 1.header(authorization) 2.query(token)              | varchar(32)                                          |
| -             |                |          | 3.cookie(authorization) (备用字段)                  |                                                      |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| signin_url    | 登陆地址       | 字符串   | 未指定redirect时候,默认的跳转地址， 默认为audience  | varchar(2048)                                        |
| signin_check  | 登陆确认       | 数值     | false, 登陆是否需要确认                             | tinyint(4) DEFAULT 0                                 |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |

---
## 角色实体(`role`)

一个用户登陆系统后,只能有一个角色存在,如果有多角色的情况,需要进行选择
本质上角色是没有域的概念的,但是为了方便管理,所以证件域的选项

gateway -> role -> role -> user -> role -> user

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| kid           | 唯一标识       | 字符串   | casbin系统中使用， 全局字段                         | varchar(64), udx_role_kid                            |
| svc_id        | 服务标识       | 数值     |                                                     | int(11), fk_role_sid->app_service.id                 |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| name          | 角色名称       | 字符串   | casbin系统使用， 租户内部字段                       | varchar(64), udx_role_name                           |
| org_cod       | 租户标识       | 字符串   | 角色归属的租户， 1表示平台                          | varchar(64), udx_role_name,fk_role_org_cod->tenant.code |
| org_adm       | 管理员         | 数值     | 1:是管理员 0:普通用户 ->管理员跳过机构内部权限      | tinyint(4) DEFAULT 1                                 |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| status        | 状态           | 数值     | 1:启用 0:禁用 2:未激活(备用)                        | tinyint(4) DEFAULT 1                                 |
| description   | 角色描述       | 字符串   |                                                     | varchar(255)                                         |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |

---
## 角色角色实体(`role_role`)

角色赋值时候,可能出现环,所以在保存角色时候,需要对角色进行校验,防止环形角色情况发生
角色中,会出现递归授权的问题,如何做到角色快速可达,是一个问题, 不过我们可以通过[Enforcer.GetImplicitRolesForUser]快速获取用户的角色列表

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| pid           | 父节点标识     | 数值     |                                                     | int(11) NOT NULL, primary,fk_role_role_pid->role.id           |
| cid           | 子节点标识     | 数值     |                                                     | int(11) NOT NULL, primary,fk_role_role_cid->role.id           |
| org_cod       | 租户标识       | 数值     |                                                     | varchar(64), fk_role_role_org_cod->tenant.code       |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |

---
## 用户角色实体(`user_role`)

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| user_id       | 账户标识       | 数值     |                                                     | int(11) NOT NULL, primary,fk_user_role_user_id->user.id       |
| role_id       | 角色标识       | 数值     |                                                     | int(11) NOT NULL, primary,fk_user_role_role_id->role.id       |
| org_cod       | 租户标识       | 字符串   |                                                     | varchar(64), fk_user_role_org_cod->tenant.code       |
| expired       | 授权有效期     | 时间格式 |                                                     | timestamp                                            |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |


---
## 用户角色实体(`role_policy`)

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| role_id       | 角色标识       | 数值     |                                                     | int(11) NOT NULL, primary,fk_role_policy_role_id->role.id     |
| plcy_id       | 策略标识       | 数值     |                                                     | int(11) NOT NULL, primary,fk_role_policy_plcy_id->role.id     |
| org_cod       | 租户标识       | 字符串   |                                                     | varchar(64), fk_role_policy_org_cod->tenant.code     |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |


---
## 用户角色实体(`user_policy`)

用户直接指定策略， 保留， 暂时不使用

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| user_id       | 账户标识       | 数值     |                                                     | int(11) NOT NULL, primary,fk_role_role_user_id->user.id       |
| plcy_id       | 策略标识       | 数值     |                                                     | int(11) NOT NULL, primary,fk_role_role_plcy_id->role.id       |
| org_cod       | 租户标识       | 字符串   |                                                     | varchar(64), fk_user_policy_org_cod->tenant.code     |
| expired       | 授权有效期     | 时间格式 |                                                     | timestamp                                            |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |

---
## 策略服务操作实体(`policy_service_action`)

是一组API的集合， 专注于一组API的操作

确认一个api接口： <service>:<action>:<resource>

resource： 为数组结构， 使用“:”进行分割

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| svc_id        | 服务标识       | 数值     |                                                     | int(11), fk_policy_service_action_sid->app_service.id |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| name          | 操作名称       | 字符串   |                                                     | varchar(64), udx_policy_service_action_name          |
| resource      | 资源列表       | 字符串   | 访问需要请求的资源, 使用“;”进行分割                 | varchar(255)                                         |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| status        | 状态           | 数值     | 1:启用 0:禁用 2:未激活                              | tinyint(4) DEFAULT 1                                 |
| description   | 描述           | 字符串   |                                                     | varchar(255)                                         |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |

---
## 策略实体(`policy`)

租户认证器Casbin只处理 service

1.用户访问提供信息， org_code, domain, path
2.处理domain/path=service （黏贴性：如果授权租户可以访问一个模块中的一个功能， 那么就可以访问该模块的所有功能， 模块的定义是: 可独立部署）
3.使用org_code/service， 判断租户是否有对应服务的使用权限
4.用户访问提供信息， service, role, user, path(relative)

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| use_ver       | 版本           | 字符串   |                                                     | varchar(16) DEFAULT '1'                              |
| org_cod       | 组织标识       | 字符串   | 角色归属的组织， 1表示平台                          | varchar(64), udx_policy_name, fk_policy_org_cod->tenant.code |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| name          | 策略名称       | 字符串   | casbin系统使用， 组织内部字段                       | varchar(64), udx_policy_name                         |
| status        | 状态           | 数值     | 1:启用 0:禁用 2:未激活                              | tinyint(4) DEFAULT 1                                 |
| description   | 描述           | 字符串   |                                                     | varchar(255)                                         |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |

---
## 策略声明(`policy_statement`)

“*”代表0个或多个任意的英文字母, “?”代表1个任意的英文字母
action,resource为数组字段，使用“;”进行分割

Action格式： [<service>:<action>]
例子： ['log:List*', 'log:Describe*']， 标识可以访问log服务中所有List开头和Describe开头的接口

<action> = [<relative>]

Resource格式： ['fmes:<org/user>:<service>:<role>:<user>:<relative>']

org/user: 租户KID(平台字段，租户内部被忽略), 用于平台对某一个用户行为进行处理
service: 服务COD (平台租户可用)
role: 角色COD (租户可用)， 平台忽略该字段
user: 用户KID (租户可用)， 平台忽略该字段
relative：资源地址 (平台租户可用)

condition: 条件， 策略预计成立的条件
比如：
```json
{
  "access_source_ip": { 
      "netmask": ["192.168.0.1/12"]
  },
  "access_time": { 
      "times": ["2020-12-12 00:00:00", "2021-02-02 00:00:00"]
  },
}
```

注意： 该表没有主键， 理论上无法执行更新操作， 只支持插入和批量删除， 其中批量删除使用plcy_id + version

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| plcy_id       | 策略标识       | 数值     |                                                     | int(11) NOT NULL, idx_policy_statement, fk_policy_statement_plcy_id->policy.id |
| plcy_ver      | 数据版本       | 数值     |                                                     | int(11) NOT NULL, idx_policy_statement               |
| effect        | 相应           | 数值     | 1: allow 0:deny                                     | tinyint(4)                                           |
| action        | 操作           | 字符串   |                                                     | varchar(255)                                         |
| resource      | 资源           | 字符串   |                                                     | varchar(255)                                         |
| condition     | 条件           | 字符串   | json                                                | varchar(255)                                         |
| description   | 描述           | 字符串   |                                                     | varchar(255)                                         |

---
## 第三方登陆实体(`platform`)

用于第三方授权登陆我们的系统

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| id            | 唯一标识       | 数值     |                                                     | int(11) NOT NULL AUTO_INCREMENT, primary             |
| kid           | 三方标识       | 字符串   |                                                     | varchar(64)  NOT NULL, udx_oauth2_platform_kid       |
| type          | 平台标识       | 字符串   | 1:WX 2:TB 3:JD 4:GITEA 5: WXQ 6...                  | varchar(32) NOT NULL                                 |
| signin        | 可登陆         | 数值     | 1:启用 0:禁用                                       | tinyint(4) DEFAULT 0                                 |
| org_cod       | 租户标识       | 字符串   | 如果不为空,表示账户和租户绑定                       | varchar(64), fk_platform_org_cod->tenant.cod         |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| avatar        | 平台头像       | 字符串   |                                                     | varchar(255)                                         |
| status        | 状态           | 数值     | 1:启用 0:禁用                                       | tinyint(4) DEFAULT 1                                 |
| description   | 平台描述       | 字符串   |                                                     | varchar(255)                                         |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| app_id        | 应用标识       | 字符串   |                                                     | varchar(128)                                         |
| app_secret    | 应用密钥       | 字符串   |                                                     | varchar(1024)                                        |
| agent_id      | 代理商标识     | 字符串   |                                                     | varchar(128)                                         |
| agent_secret  | 代理商密钥     | 字符串   |                                                     | varchar(1024)                                        |
| suite_id      | 套件标识       | 字符串   |                                                     | varchar(128)                                         |
| suite_secret  | 套件密钥       | 字符串   |                                                     | varchar(1024)                                        |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| authorize_url | 认证地址       | 字符串   |                                                     | varchar(1024)                                        |
| token_url     | 令牌地址       | 字符串   |                                                     | varchar(1024)                                        |
| profile_url   | 个人资料地址   | 字符串   |                                                     | varchar(1024)                                        |
| signin_url    | 重定向回调地址 | 字符串   | 上游应用无法获取https时候替代方案                   | varchar(128)                                         |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| js_secret     | javascript密钥 | 字符串   | 需要js签名认证时候,进行认证的key                    | varchar(255)                                         |
| state_secret  | 回调state密钥  | 字符串   | 缓存处理state,用密钥计算state具有更好的分布式       | varchar(255)                                         |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| callback      | 是否支持回调   | 数值     |                                                     | tinyint(4) DEFAULT 0                                 |
| cb_domain     | 默认域名       | 字符串   |                                                     | varchar(128)                                         |
| cb_scheme     | 默认协议       | 字符串   |                                                     | varchar(16) DEFAULT 'https'                          |
| cb_encrypt    | 回调是否加密   | 数值     |                                                     | tinyint(4) DEFAULT 0                                 |
| cb_token      | 加密令牌       | 字符串   |                                                     | varchar(255)                                         |
| cb_encoding   | 加密编码       | 字符串   |                                                     | varchar(255)                                         |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |

---
## 通信令牌实体(`token`)

使用的令牌,为我服务器使用令牌与其他服务器通信的记录,也可用于集群中应用对第三方服务器访问的信息共享

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| token_kid     | 角色标识       | 字符串   |                                                     | varchar(64) NOT NULL, primary                        |
| account_id    | 令牌归属       | 数值     |                                                     | int(11), idx_token_account_id                        |
| org_cod       | 组织标识       | 字符串   |                                                     | varchar(64)                                          |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| access_token  | 访问令牌       | 字符串   |                                                     | varchar(4096)                                        |
| expires_at    | 访问令牌       | 数值     |                                                     | int(11)                                              |
| refresh_token | 刷新令牌       | 字符串   |                                                     | varchar(255), idx_token_refresh_token                |
| refresh_exp   | 刷新令牌       | 数值     |                                                     | int(11)                                              |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| delay_token   | 延迟令牌       | 字符串   | 延迟令牌， 用于第三方用户延迟拉取                   | varchar(255), idx_token_delay_token                  |
| delay_exp     | 延迟令牌       | 数值     |                                                     | int(11)                                              |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| call_count    | 调用次数       | 数值     | 令牌被使用的次数, 注意开发时需要降低更新频次        | int(11) DEFAULT 0                                    |
| sync_lock     | 同步锁         | 数值     | 同步锁,使用时间锁,防止死锁                          | int(11)                                              |
| refresh_count | 刷新次数       | 数值     |                                                     | int(11) DEFAULT 0                                    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| last_ip       | 上次登陆IP     | 字符串   |                                                     | varchar(64)                                          |
| last_at       | 上次登陆时间   | 时间格式 |                                                     | timestamp                                            |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| error_code    | 异常类型       | 字符串   | 不为空， 禁止使用                                   | varchar(64)                                          |
| error_message | 异常信息       | 字符串   | 系统拦截异常                                        | varchar(255)                                         |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| string_1      | 备用字段       | 字符串   |                                                     | varchar(255)                                         |
| number_1      | 备用字段       | 数值     |                                                     | int(11)                                              |

---
## 系统标签实体(`tag_system`)

系统标签可直接被删除

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| type          | 标签类型       | 字符串   | 1:用户 2:角色 3:资源 4:平台 5:客户端                | varchar(64) NOT NULL, primary                        |
| bid           | 归属id         | 数值     |                                                     | int(11) NOT NULL, primary                            |
| tag           | 标签           | 字符串   |                                                     | varchar(64) NOT NULL, primary                        |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |

---
## 通用标签实体(`tag_custom`)

不可直接删除,但是可以通过逻辑删除标识删除,自定义标签为一种随意标签,本身不会影响系统运行,但是可以提供筛选条件,用于分析用户等行为

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| type          | 标签类型       | 字符串   | 1:用户 2:角色 3:资源 4:平台 5:客户端                | varchar(64) NOT NULL, primary                        |
| bid           | 归属id         | 数值     |                                                     | int(11) NOT NULL, primary                            |
| tag           | 标签           | 字符串   |                                                     | varchar(64) NOT NULL, primary                        |
| deleted       | 删除标识       | 字符串   | false                                               | tinyint(4) DEFAULT 0                                 |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |

---
## 国际化实体(`i18n_language`)

| 字段          | 中文说明       | 字段类型 | 备注                                                | MYSQL                                                |
| ------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| mid           | message id     | 字符串   |                                                     | varchar(255) NOT NULL, primary                       |
| lang          | 语言           | 字符串   | zh-CN, en-US                                        | varchar(16) NOT NULL, primary                        |
| description   | 描述           | 字符串   |                                                     | varchar(64)                                          |
| left_delim    | 定界符         | 字符串   | 左边模板定界符                                      | varchar(16)                                          |
| right_delim   | 定界符         | 字符串   | 右边模板定界符                                      | varchar(16)                                          |
| zero          | zero           | 字符串   |                                                     | varchar(255)                                         |
| one           | one            | 字符串   |                                                     | varchar(255)                                         |
| two           | two            | 字符串   |                                                     | varchar(255)                                         |
| few           | few            | 字符串   |                                                     | varchar(255)                                         |
| many          | many           | 字符串   |                                                     | varchar(255)                                         |
| other         | other          | 字符串   | 默认                                                | varchar(255)                                         |
| status        | 状态           | 数值     | 1:启用 0:禁用                                       | tinyint(4) DEFAULT 1                                 |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| creator       | 创建人         | 字符串   |                                                     | varchar(64)                                          |
| created_at    | 创建时间       | 时间格式 |                                                     | timestamp                                            |
| updated_at    | 更新时间       | 时间格式 |                                                     | timestamp                                            |
| version       | 数据版本       | 数值     |                                                     | int(11) DEFAULT 0                                    |

---